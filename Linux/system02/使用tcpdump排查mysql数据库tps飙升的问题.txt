现象:
上线后习惯性的观察数据库的变化。发现数据库的tps有很大的飙升。不过幸好在双十一的时候在数据库方面做了一些完善，虽然主库的tps有飙升，但是总体load还不是很高。但是问题既然出现了，还是要解决的。 排查过程 确定是insert update 还是 delete操作

排查过程
确定是insert update 还是 delete操作导致tps高？
通过监控可以很清楚的看出来是update操作多了导致的

到底是那些update语句导致tps高？

当时程序中并没有记录所有执行的sql语句。因此，没有一个现成的数据文件供分析。Sql语句是通过网络以文本方式传输到mysql服务器端的。因此我们完全可以通过tcpdump这个工具把所有的sql语句捕获到。

首先，为了便于比对，我先把一台服务器上的代码回滚到上线前的版本。

其次，我在两台服务器上同时执行tcpdump命令，以捕获所有执行的sql脚本。这两台服务器分别运行着上线前的旧版本程序和上线后的新版本程序。抓包命令如下：
$sudo tcpdump -i eth0 -A -s 3000 port 3306 > ~/sql.log
注意，我们在使用tcpdump的时候加了-A参数，这样就可以把sql语句都显示出来了。更多tcpdump使用，可以查看文章 调试利器之tcpdump详解


大约执行1分钟后，同时停止执行。这个时候，sql.log文件中已经包含了这段时间执行的所有sql语句。示例如下：
$grep 'update' ./sql.log | head
....5u.vD....update session_table set expire=’2014-12-12 20:01:23’ where sess_id = ‘demostring123’ limit 1

既然我们现在已经有了所有执行的sql语句，我们就可以很容易的通过使用grep， wc 等命令分析出是那些sql语句执行次数猛增了。  以及sort uniq 





各参数说明如下：
    -a    将网络地址和广播地址转变成名字；
    -b    在数据-链路层上选择协议，包括ip、arp、rarp、ipx都是这一层的。tcpdump -b arp 将只显示网络中的arp即地址转换协议信息；
    -c    在收到指定数目的包后，tcpdump就会停止；
    -d    将匹配信息包的代码以人们能够理解的汇编格式给出；
    -dd   将匹配信息包的代码以c语言程序段的格式给出；
    -ddd  将匹配信息包的代码以十进制的形式给出；
    -e    在输出行打印出数据链路层的头部信息；
    -f    将外部的Internet地址以数字的形式打印出来；
    -F    从指定的文件中读取表达式,忽略其它的表达式；
    -i    指定监听的网络接口；
    -l    使标准输出变为缓冲行形式,如tcpdump -l >tcpcap.txt将得到的数据存入tcpcap.txt文件中；
    -n    不进行IP地址到主机名的转换；
    -N    不打印出默认的域名
    -nn   n不进行端口名称的转换；
    -O    不进行匹配代码的优化，当怀疑某些bug是由优化代码引起的, 此选项将很有用；
    -r    从指定的文件中读取包(这些包一般通过-w选项产生)；
    -s    抓取数据包时默认抓取长度为68字节。加上 -s 0 后可以抓到完整的数据包
    -t    在输出的每一行不打印UNIX时间戳，也就是不显示时间；
    -T    将监听到的包直接解释为指定的类型的报文，常见的类型有rpc(远程过程调用)和snmp；
    -tt   打印原始的、未格式化过的时间；
    -v    输出一个稍微详细的信息，例如在ip包中可以包括ttl和服务类型的信息；
    -vv   输出详细的报文信息；
    -w    直接将包写入文件中，并不分析和打印出来；

tcpdump [-i 网卡] -nnAX '表达式'
    -i：   interface 监听的网卡。
    -nn：  表示以ip和port的方式显示来源主机和目的主机，而不是用主机名和服务。
    -A：   以ascii的方式显示数据包，抓取web数据时很有用。
    -X：   数据包将会以16进制和ascii的方式显示。
    表达式：表达式有很多种，常见的有：host 主机；port 端口；src host 发包主机；dst host 收包主机。多个条件可以用and、or组合，取反可以使用!，更多的使用可以查看man 7 pcap-filter。