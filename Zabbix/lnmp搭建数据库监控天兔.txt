Lepus(天兔)数据库监控系统是是一款专业、强大的数据库监控管理系统，通过Lepus可以监控数据库的实时健康和各项性能指标，目前已支持MySQL、Oracle、MongoDB、Redis数据库的全面监控，Lepus能够查看各种实时性能状态指标，并且对监控、性能数据进行统计分析。
首先安装pip
1、安装epel-release
[root@localhost ~]# yum -y install epel-release
2、安装python-pip
[root@localhost ~]# yum -y install python-pip
3、升级pip
[root@localhost ~]# pip install --upgrade pip
4、检查pip版本
[root@localhost ~]# pip --version

 5、修改pip源
复制代码
[root@localhost ~]# cd ~  #回到家目录
[root@localhost ~]# mkdir .pip  #创建.pip目录
[root@localhost ~]# cd .pip
[root@localhost .pip]# touch pip.conf  #创建pip.conf配置文件
[root@localhost .pip]# vi pip.conf
#在配置文件中增加如下内容
[global]
index-url = http://pypi.douban.com/simple
[install]
trusted-host = pypi.douban.com
#配置文件保存


1.安装 MySQLdb for python （如果需要监控MySQL则必须安装）
MySQLdb为Python连接和操作MySQL的类库，如果您准备使用lepus系统监控MySQL数据库，那么该模块必须安装。 
安装步骤如下： 
wget http://www.mtop.cc/software/MySQLdb-python.zip   ##https://files.pythonhosted.org/packages/a5/e9/51b544da85a36a68debe7a7091f068d802fc515a3a202652828c73453cad/MySQL-python-1.2.5.zip
unzip MySQLdb-python.zip 
cd MySQLdb1-master/ 
which mysql_config  ##若没有找到则需要安装yum -y install mysql-devel
 /usr/local/mysql/bin/mysql_config 

vim site.cfg 修改如下： 
mysql_config = /usr/local/mysql/bin/mysql_config 

python setup.py build 

python setup.py install 


常见错误解决： 
1).如果编译python出现如下问题 
/usr/bin/ld: cannot find -lpython2.7 
collect2: ld returned 1 exit status 
error: command 'gcc' failed with exit status 1 

请按如下步骤处理： 
A.检查并安装python-devel包 
# yum -y install python-devel 

B.将libpython2.7.so库文件建立软连接到/usr/lib下 
32位服务器下执行 
# ln -s /usr/local/Python2.7/lib/libpython2.7.so /usr/lib/libpython2.7.so 

64位服务器下执行 
# ln -s /usr/local/Python2.7/lib/libpython2.7.so /usr/lib64/libpython2.7.so 

C.检查下/etc/ld.so.conf是否包含/usr/local/Python2.7/lib 
#vi /etc/ld.so.conf 添加/usr/local/Python2.7/lib 
#/sbin/ldconfig 

{{
也可以采用下面这种方式安装
2、安装python基础环境
我这里使用Centos7默认的python就好（Python版本要求为Python2.6以上,不支持Python3），MySQL-python必须安装
yum -y install mysql-devel
yum -y install python-devel
pip install MySQL-python==1.2.5  ##如果不安装上述两个步骤可能会报错
}}



安装cx_oracle 
[root@westserver software]# tar zxvf cx_Oracle-5.1.2.tar.gz  ##https://oracle.github.io/python-cx_Oracle/
[root@westserver software]# cd cx_Oracle-5.1.2 
[root@westserver cx_Oracle-5.1.2]# python setup.py build 
[root@westserver cx_Oracle-5.1.2]# python setup.py install 

{{
或者如下
2.安装cx_Oraclep
python -m pip install cx-oracle==5.3
}}


3.安装Pymongo for python （如果需要监控Mongodb则必须安装）
pymongo为Python连接和操作MongoDB的类库，如果您准备使用lepus系统监控MongoDBs数据库，那么该模块必须安装。 
安装步骤如下: 
下载pymongo https://pypi.python.org/packages/source/p/pymongo/ 
wget www.mtop.cc/software/pymongo-2.7.tar.gz 
tar zxvf pymongo-2.7.tar.gz 
cd pymongo-2.7 
python setup.py install 

{{
这里还是采用pip安装
python -m pip install pymongo
python -m pip install --upgrade pymongo
}}


4.安装Redis 驱动 （如果需要监控Redis则必须安装）
[root@westserver software]# tar zxvf redis-py-2.10.3.tar.gz  ##https://pypi.org/project/redis/#files
[root@westserver software]# cd redis-2.10.3/ 
[root@westserver redis-2.10.3]# python setup.py install 

{{
这里采用pip安装
pip install redis
}}


测试各个驱动是否正常运行

[root@westserver lepus]# python test_driver_mysql.pyc 
MySQL python drivier is ok! 

[root@westserver lepus]# python test_driver_oracle.pyc 
Oracle python drivier is ok! 

[root@westserver lepus]# python test_driver_mongodb.pyc 
MongoDB python drivier is ok! 

[root@westserver lepus]# python test_driver_redis.pyc 
Redis python drivier is ok! 



安装nginx：
yum install -y wget gcc gcc-c++ make pcre pcre-devel zlib zlib-devel openssl openssl-devel lrzsz 
cd /usr/local/src
wget 'http://nginx.org/download/nginx-1.14.2.tar.gz'
tar -zxvf nginx-1.14.2.tar.gz
cd nginx-1.14.2
./configure --prefix=/usr/local/nginx
make && make install



安装mysql  略：也可以使用目前已有的mysql节点
mysql -uroot -p
mysql> create database lepus default character set utf8;
mysql> grant select,insert,update,delete,create on lepus.* to 'lepus_user'@'localhost' identified by 'blog.whsir.com';  ##也可以直接使用root账户，或者其他有权限的账户
mysql> flush privileges;
mysql> quit



安装php： ##好像不支持php的高版本，php5最适合
yum -y install epel-release
yum -y install  gcc gcc-c++ make pcre pcre-devel zlib zlib-devel openssl openssl-devel libxml2 libxml2-devel libcurl libcurl-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel openldap openldap-devel libmcrypt libmcrypt-devel

cd /usr/local/src/
wget 'http://hk1.php.net/distributions/php-5.6.40.tar.gz'
tar -zxf php-5.6.40.tar.gz
cd php-5.6.40
cp -frp /usr/lib64/libldap* /usr/lib/  ##否则有可能报错Cannot find ldap libraries in /usr/lib.
./configure --prefix=/usr/local/php --with-config-file-path=/usr/local/php/etc --enable-ctype --with-mysql=mysqlnd --with-mysqli=mysqlnd --with-freetype-dir --with-jpeg-dir --with-png-dir --with-zlib --with-libxml-dir=/usr --enable-xml --disable-rpath --enable-bcmath --enable-shmop --enable-sysvsem --enable-inline-optimization --with-curl --enable-mbregex --enable-mbstring --with-mcrypt --with-gd --enable-gd-native-ttf --with-openssl --with-mhash --enable-pcntl --enable-sockets --with-ldap-sasl --with-xmlrpc --enable-zip --enable-soap --with-gettext --enable-fpm --with-ldap

make && make install
{{针对报错undefined reference to symbol 'ber_strdup'的解决
编辑MakeFile 
找到 开头是 'EXTRA_LIBS' 这一行 在结尾加上 '-llber' 然后执行 make && make install }}

cp php.ini-production /usr/local/php/etc/php.ini


环境变量：export PATH=$PATH:/usr/local/php/sbin/:/usr/local/php/bin/
检查配置文件：php-fpm -t

使用默认配置文件：mv /usr/local/php/etc/php-fpm.conf.default /usr/local/php/etc/php-fpm.conf

使用默认配置文件：mv /usr/local/php/etc/php-fpm.conf.default /usr/local/php/etc/php-fpm.conf
[Unit]
Description=php-fpm
After=network.target
[Service]
Type=forking
ExecStart=/usr/local/php/sbin/php-fpm
[Install]
WantedBy=multi-user.target


启动php-fpm
systemctl start php-fpm

nginx的默认配置无法处理php程序/usr/local/nginx/html/test.php
<?php
  echo "天兔";
?>



nginx+php-fpm结合的配置
        location / {
            root   html;   ###根据自己的路径配置
            index  index.php;
            
            if (!-e $request_filename)    ##下面这几行必须添加否则报错404
            {
               rewrite  ^(.*)$ /index.php?s=$1 last;
               break;
            }
        }
		
		location ~ \.php$ {
            root     html;  ###根据自己的路径配置
            fastcgi_pass   localhost:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  /usr/local/nginx/html$fastcgi_script_name;   ###项目根目录/usr/local/nginx/html
            include        fastcgi_params; 
        }
		


安装天兔监控
yum install  gcc python-devel net-snmp-devel curl-devel perl-DBI php-gd php-mysql php-bcmath php-mbstring php-xml -y
cd /usr/local/src/
wget http://down.whsir.com/downloads/Lepus_v3.8_beta.tar.gz
tar xf Lepus_v3.8_beta.tar.gz

mysql里导入天兔数据  ##或者使用source
cd /usr/local/src/Lepus_v3.8_beta  ###根据自己的路径
mysql -uroot -pwhsir lepus < sql/lepus_table.sql
mysql -uroot -pwhsir lepus < sql/lepus_data.sql

##否则可能报错不出数据
mysql>use lepus
mysql>alter table mysql_status modify column max_connect_errors bigint(18);
mysql>alter table mysql_status_history modify column max_connect_errors bigint(18);



安装Lpeus(天兔)程序
cd /usr/local/src/Lepus_v3.8_beta/python
chmod +x ./*
./install.sh
[note] lepus will be install on basedir: /usr/local/lepus
[note] /usr/local/lepus directory does not exist,will be created.
[note] /usr/local/lepus directory created success.
[note] wait copy files.......
[note] change script permission.
[note] create links.
[note] install complete.


修改lepus配置文件  ##根据自己的数据库配置
vi /usr/local/lepus/etc/config.ini  ###根据自己的数据库信息进行配置
[monitor_server]
host="127.0.0.1"
port=3306
user="lepus_user"
passwd="blog.whsir.com"
dbname="lepus"

启动Lepus
启动前设置一个软连接，不然会报错，如果启动报错请查看/usr/local/lepus/logs/lepus.log
ln -sv /usr/local/mysql/lib/libmysqlclient.so.18 /usr/lib64/libmysqlclient.so.18
lepus start


配置天兔web管理台
lepus start 

配置lepus的web界面  
cd /root/Lepus_v3.8_beta/php
cp -ap * /usr/local/nginx/html/
cd /usr/local/nginx/html/application/config
vim database.php   ###同样的根据自己的数据库进行配置

----
$db['default']['hostname'] = '127.0.0.1';  ###根据自己的数据库信息进行配置
$db['default']['port']     = '3306';
$db['default']['username'] = 'lepus';
$db['default']['password'] = 'lepus';
$db['default']['database'] = 'lepus';
$db['default']['dbdriver'] = 'mysql';
----


重启php-fpm和nginx

systemctl restart php-fpm 
./sbin/nginx -s reload 


验证：
浏览器访问：###若访问只有文字没有图形，则可以加上index.php 或者清楚浏览器缓存然后再进行访问（不用添加index.php）
http://192.168.20.73		
打开浏览器输入IP地址打开天兔数据库监控系统，默认账号密码为admin/Lepusadmin





